<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>63.0</apiVersion>
    <assignments>
        <name>Add_OLI_to_Collection</name>
        <label>Add OLI to Collection</label>
        <locationX>858</locationX>
        <locationY>1295</locationY>
        <assignmentItems>
            <assignToReference>collectionOLIs</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Loop_through_OLI</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_through_OLI</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Increase Count to 1. After loop, it will be checked with Total Items Count(Roll up Summary field on order) to check whether All OLI are Approved or Nor Needed. If yes, then send them for Approval.</description>
        <name>Increase_Count</name>
        <label>Increase Count</label>
        <locationX>1166</locationX>
        <locationY>1895</locationY>
        <assignmentItems>
            <assignToReference>count</assignToReference>
            <operator>Add</operator>
            <value>
                <numberValue>1.0</numberValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Check_for_TSA</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Update Status to Check</description>
        <name>Update_Status</name>
        <label>Update Status</label>
        <locationX>858</locationX>
        <locationY>1187</locationY>
        <assignmentItems>
            <assignToReference>Loop_through_OLI.Sample_Item_Approval_Status__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Check</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_OLI_to_Collection</targetReference>
        </connector>
    </assignments>
    <decisions>
        <description>Check whether the Count  = Total Items on Order(Roll up Summary) to sent it for ML Approval.</description>
        <name>Check_Count</name>
        <label>Check Count</label>
        <locationX>1078</locationX>
        <locationY>2171</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Update_to_Check</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>count</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>$Record.Total_Items_Count__c</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_Order</targetReference>
            </connector>
            <label>Update to Check</label>
        </rules>
    </decisions>
    <decisions>
        <description>Checks whether the status of OLI is None or Rejected</description>
        <name>Check_Status</name>
        <label>Check Status</label>
        <locationX>990</locationX>
        <locationY>1079</locationY>
        <defaultConnector>
            <targetReference>Loop_through_OLI</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Update_Status_to_Check</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>Loop_through_OLI.Sample_Item_Approval_Status__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Loop_through_OLI.Sample_Item_Approval_Status__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Rejected</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_Status</targetReference>
            </connector>
            <label>Update Status to Check</label>
        </rules>
    </decisions>
    <decisions>
        <description>Check whether the status of all OLI is Approved or Not Needed</description>
        <name>Check_Status_1</name>
        <label>Check Status</label>
        <locationX>1298</locationX>
        <locationY>1787</locationY>
        <defaultConnector>
            <targetReference>Check_for_TSA</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>Approved_or_Not_Needed</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>Check_for_TSA.Sample_Item_Approval_Status__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Approved</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>Check_for_TSA.Sample_Item_Approval_Status__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Not Needed</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Increase_Count</targetReference>
            </connector>
            <label>Approved or Not Needed?</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_User_for_Flow_Bypass</name>
        <label>Check User for Flow Bypass</label>
        <locationX>176</locationX>
        <locationY>539</locationY>
        <defaultConnector>
            <targetReference>Update_Running_User</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>User can&apos;t bypass the Validation</defaultConnectorLabel>
        <rules>
            <name>User_can_bypass_the_Validation</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_Bypass_Flows_User_related_Flow.Is_Bypass__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <label>User can bypass the Validation</label>
        </rules>
    </decisions>
    <decisions>
        <description>Checks whether collection is empty or not. 
If empty, meaning no OLI needs to be update.</description>
        <name>Is_Collection_Empty</name>
        <label>Is Collection Empty?</label>
        <locationX>770</locationX>
        <locationY>1571</locationY>
        <defaultConnector>
            <targetReference>Check_for_TSA</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Yes</defaultConnectorLabel>
        <rules>
            <name>No</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>collectionOLIs</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_OLI</targetReference>
            </connector>
            <label>No</label>
        </rules>
    </decisions>
    <decisions>
        <description>Checks if the Opportunity Line Items (OLI) are empty. If they are, the flow is stopped to avoid errors caused by null values.</description>
        <name>Is_OLI_Empty</name>
        <label>Is OLI Empty?</label>
        <locationX>462</locationX>
        <locationY>863</locationY>
        <defaultConnector>
            <targetReference>Loop_through_OLI</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Get_OLI</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <label>Yes</label>
        </rules>
    </decisions>
    <description>Sample Order Approval Orchestration Process. 
Check for each item&apos;s &quot; Sample Item Approval Status&quot;- if it is None or Rejected - then set the &quot;Sample Item Approval Status &quot; of that Item to &quot;Check&quot;. 
1. If all the items&apos; &quot;Sample Item Approval Status&quot; are either in &quot;Approved&quot; or &quot;Not Needed&quot; 
a. Set the &quot;ML Approval Status&quot; - &quot;Check&quot;</description>
    <environments>Default</environments>
    <interviewLabel>Order - Master Approval Order Flow {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Order - Master Approval Order Flow</label>
    <loops>
        <description>Loop through the same list of OLI again to check for ML approval incase no record is needed Sample Order Item Level Approval. Check the status = &apos;Approved&apos; or &apos;Not Needed&apos;</description>
        <name>Check_for_TSA</name>
        <label>Check for TSA</label>
        <locationX>1078</locationX>
        <locationY>1679</locationY>
        <collectionReference>Get_OLI</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Check_Status_1</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Check_Count</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <description>Loop through OLI to check whether OLI needs an Approval or not.</description>
        <name>Loop_through_OLI</name>
        <label>Loop through OLI</label>
        <locationX>770</locationX>
        <locationY>971</locationY>
        <collectionReference>Get_OLI</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Check_Status</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Is_Collection_Empty</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <description>Get the current user details if he can bypass the validation</description>
        <name>Get_Bypass_Flows_User</name>
        <label>Get Bypass Flows - User</label>
        <locationX>176</locationX>
        <locationY>323</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Bypass_Flows_User_related_Flow</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Username__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$User.Username</elementReference>
            </value>
        </filters>
        <filters>
            <field>Active__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Bypass_Flows_User__mdt</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Get the bypass user-related flow - child of Bypass Flows - user</description>
        <name>Get_Bypass_Flows_User_related_Flow</name>
        <label>Get Bypass Flows - User related Flow</label>
        <locationX>176</locationX>
        <locationY>431</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Check_User_for_Flow_Bypass</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Flow_Name__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Order_Master_Approval_Order_Flow</stringValue>
            </value>
        </filters>
        <filters>
            <field>Data_Load_User__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Bypass_Flows_User.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Bypass_Flows_User_related_Flow__mdt</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <description>Get all OLI related to this</description>
        <name>Get_OLI</name>
        <label>Get OLI</label>
        <locationX>462</locationX>
        <locationY>755</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Is_OLI_Empty</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>OrderId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>OrderItem</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <description>Update OLI to check</description>
        <name>Update_OLI</name>
        <label>Update OLI</label>
        <locationX>462</locationX>
        <locationY>1679</locationY>
        <inputReference>collectionOLIs</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Order</name>
        <label>Update Order</label>
        <locationX>946</locationX>
        <locationY>2279</locationY>
        <inputAssignments>
            <field>TSCA_Approval_Status__c</field>
            <value>
                <stringValue>Check</stringValue>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Running_User</name>
        <label>Update Running User</label>
        <locationX>462</locationX>
        <locationY>647</locationY>
        <connector>
            <targetReference>Get_OLI</targetReference>
        </connector>
        <inputAssignments>
            <field>Running_User_for_Approval__c</field>
            <value>
                <elementReference>$User.Username</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <start>
        <locationX>50</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Get_Bypass_Flows_User</targetReference>
        </connector>
        <filterLogic>( 1 AND 2 AND 3 AND 4 ) or (5 AND 6 AND 7 AND 3) OR ( 3 AND 5 AND 6  AND 1 AND 2)</filterLogic>
        <filters>
            <field>Status</field>
            <operator>IsChanged</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Status</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Submitted/ In Approval</stringValue>
            </value>
        </filters>
        <filters>
            <field>Salesforce_Order_Type__c</field>
            <operator>NotEqualTo</operator>
            <value>
                <stringValue>ZOR</stringValue>
            </value>
        </filters>
        <filters>
            <field>Created_From_Portal__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Created_From_Portal__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Distributor_Submission_Approval_Status__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Approved</stringValue>
            </value>
        </filters>
        <filters>
            <field>Distributor_Submission_Approval_Status__c</field>
            <operator>IsChanged</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <object>Order</object>
        <recordTriggerType>CreateAndUpdate</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <variables>
        <name>blnSentForML</name>
        <dataType>Boolean</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>collectionOLIs</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>OrderItem</objectType>
    </variables>
    <variables>
        <description>Checks if count = total Items count. 
Total Items Count is existing rollup summary field present on order which gives Total Items Count. 
count variable is created to check all the OLI are whether Approved or Not Needed. If yes, then sent them for ML Approval.</description>
        <name>count</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
    </variables>
    <variables>
        <name>RunningUser</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
