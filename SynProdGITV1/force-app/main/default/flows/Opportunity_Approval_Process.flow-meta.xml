<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>65.0</apiVersion>
    <decisions>
        <name>Approved_Rejected</name>
        <label>Approved/Rejected?</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <defaultConnector>
            <targetReference>Update_Opportunity_Status_Rejected</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Rejected</defaultConnectorLabel>
        <rules>
            <name>Approved</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Approval_Step_Opportunity.Outputs.approvalDecision</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Approve</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_Opportunity_Status_Approved</targetReference>
            </connector>
            <label>Approved</label>
        </rules>
    </decisions>
    <description>Flow Approval Orchestration will be used to submit the Opportunity for approval. The approval will be routed to the Opportunity Owner’s Manager whenever the Stage is set to Adoption. While the record is under approval, both the Sales Admin and the Owner’s Manager will be able to make edits. This access will be granted by assigning a dedicated permission set to Sales Admin and Manager. Record locking will be enforced through a Validation Rule.</description>
    <environments>Default</environments>
    <formulas>
        <name>URLBase</name>
        <dataType>String</dataType>
        <expression>LEFT({!$Api.Enterprise_Server_URL_610}, FIND(&quot;/services&quot;, {!$Api.Enterprise_Server_URL_610}) - 1)</expression>
    </formulas>
    <interviewLabel>Opportunity - Approval Process {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Opportunity - Approval Process</label>
    <orchestratedStages>
        <description>Submit Opportunity to Owner&apos;s Manager.</description>
        <name>Approval_Step</name>
        <label>Approval Step</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Approved_Rejected</targetReference>
        </connector>
        <exitConditionLogic>and</exitConditionLogic>
        <stageSteps>
            <name>Approval_Step_Opportunity</name>
            <actionName>standard_approvals__EvaluateApproval</actionName>
            <actionType>stepApproval</actionType>
            <assignees>
                <assignee>
                    <elementReference>$Record.Owner.Manager.Username</elementReference>
                </assignee>
                <assigneeType>Resource</assigneeType>
            </assignees>
            <entryConditionLogic>and</entryConditionLogic>
            <exitConditionLogic>and</exitConditionLogic>
            <inputParameters>
                <name>ActionInput__RecordId</name>
                <value>
                    <elementReference>$Record.Id</elementReference>
                </value>
            </inputParameters>
            <inputParameters>
                <name>ActionInput__CustomEmailSubject</name>
                <value>
                    <elementReference>emailSubject</elementReference>
                </value>
            </inputParameters>
            <inputParameters>
                <name>ActionInput__CustomEmailBody</name>
                <value>
                    <elementReference>emailBody</elementReference>
                </value>
            </inputParameters>
            <label>Approval Step</label>
            <requiresAsyncProcessing>false</requiresAsyncProcessing>
            <runAsUser>false</runAsUser>
            <stepSubtype>ApprovalStep</stepSubtype>
        </stageSteps>
    </orchestratedStages>
    <orchestratedStages>
        <name>Get_Opportunity_Product_Details</name>
        <label>Get Opportunity Product Details</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Update_Opportunity_Status</targetReference>
        </connector>
        <exitConditionLogic>and</exitConditionLogic>
        <stageSteps>
            <name>Get_Product_Details</name>
            <actionName>Opportunity_Get_Opportunity_Product_Details</actionName>
            <actionType>stepBackground</actionType>
            <entryConditionLogic>and</entryConditionLogic>
            <exitConditionLogic>and</exitConditionLogic>
            <inputParameters>
                <name>recordId</name>
                <value>
                    <elementReference>$Record.Id</elementReference>
                </value>
            </inputParameters>
            <label>Get Product Details</label>
            <requiresAsyncProcessing>false</requiresAsyncProcessing>
            <runAsUser>false</runAsUser>
            <stepSubtype>BackgroundStep</stepSubtype>
        </stageSteps>
    </orchestratedStages>
    <orchestratedStages>
        <description>Update Opportunity Status to &apos;In Approval&apos;</description>
        <name>Update_Opportunity_Status</name>
        <label>Update Opportunity Status</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Approval_Step</targetReference>
        </connector>
        <exitConditionLogic>and</exitConditionLogic>
        <stageSteps>
            <name>Update_Status_to_In_Approval</name>
            <actionName>Opportunity_Manager_Approval_Approved_Rejected</actionName>
            <actionType>stepBackground</actionType>
            <entryConditionLogic>and</entryConditionLogic>
            <exitConditionLogic>and</exitConditionLogic>
            <inputParameters>
                <name>opportunityApprovalStatus</name>
                <value>
                    <stringValue>In Approval</stringValue>
                </value>
            </inputParameters>
            <inputParameters>
                <name>opportunityId</name>
                <value>
                    <elementReference>$Record.Id</elementReference>
                </value>
            </inputParameters>
            <label>Update Status to In Approval</label>
            <requiresAsyncProcessing>false</requiresAsyncProcessing>
            <runAsUser>false</runAsUser>
            <stepSubtype>BackgroundStep</stepSubtype>
        </stageSteps>
    </orchestratedStages>
    <orchestratedStages>
        <description>Update Opportunity Status to &apos;In Approval&apos;</description>
        <name>Update_Opportunity_Status_Approved</name>
        <label>Update Opportunity Status</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <exitConditionLogic>and</exitConditionLogic>
        <stageSteps>
            <name>Update_Status_to_Approved</name>
            <actionName>Opportunity_Manager_Approval_Approved_Rejected</actionName>
            <actionType>stepBackground</actionType>
            <entryConditionLogic>and</entryConditionLogic>
            <exitConditionLogic>and</exitConditionLogic>
            <inputParameters>
                <name>opportunityApprovalStatus</name>
                <value>
                    <stringValue>Approved</stringValue>
                </value>
            </inputParameters>
            <inputParameters>
                <name>opportunityId</name>
                <value>
                    <elementReference>$Record.Id</elementReference>
                </value>
            </inputParameters>
            <label>Update Status to Approved</label>
            <requiresAsyncProcessing>false</requiresAsyncProcessing>
            <runAsUser>false</runAsUser>
            <stepSubtype>BackgroundStep</stepSubtype>
        </stageSteps>
    </orchestratedStages>
    <orchestratedStages>
        <description>Update Opportunity Status to &apos;In Approval&apos;</description>
        <name>Update_Opportunity_Status_Rejected</name>
        <label>Update Opportunity Status</label>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <exitConditionLogic>and</exitConditionLogic>
        <stageSteps>
            <name>Update_Status_to_Rejected</name>
            <actionName>Opportunity_Manager_Approval_Approved_Rejected</actionName>
            <actionType>stepBackground</actionType>
            <entryConditionLogic>and</entryConditionLogic>
            <exitConditionLogic>and</exitConditionLogic>
            <inputParameters>
                <name>opportunityApprovalStatus</name>
                <value>
                    <stringValue>Rejected</stringValue>
                </value>
            </inputParameters>
            <inputParameters>
                <name>opportunityId</name>
                <value>
                    <elementReference>$Record.Id</elementReference>
                </value>
            </inputParameters>
            <label>Update Status to Rejected</label>
            <requiresAsyncProcessing>false</requiresAsyncProcessing>
            <runAsUser>false</runAsUser>
            <stepSubtype>BackgroundStep</stepSubtype>
        </stageSteps>
    </orchestratedStages>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>ApprovalWorkflow</processType>
    <runInMode>SystemModeWithoutSharing</runInMode>
    <start>
        <locationX>0</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Get_Opportunity_Product_Details</targetReference>
        </connector>
        <doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>
        <filterLogic>and</filterLogic>
        <filters>
            <field>StageName</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Adoption</stringValue>
            </value>
        </filters>
        <object>Opportunity</object>
        <recordTriggerType>CreateAndUpdate</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <textTemplates>
        <name>emailBody</name>
        <isViewedAsPlainText>true</isViewedAsPlainText>
        <text>&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset=&quot;UTF-8&quot;&gt;&lt;title&gt;Opportunity Submitted for Approval&lt;/title&gt;&lt;/head&gt;&lt;body style=&quot;font-family:Arial,sans-serif;font-size:14px;color:#000;line-height:1.6;background-color:#f8fbff;&quot;&gt;&lt;p&gt;Dear {!$Record.Owner.Manager.FirstName},
&lt;/p&gt;&lt;p&gt;The Opportunity &lt;strong style=&quot;color:#1a73e8;&quot;&gt;&quot;{!$Record.Name}&quot;&lt;/strong&gt; has been &lt;strong style=&quot;color:#1a73e8;&quot;&gt;submitted for your approval&lt;/strong&gt;.&lt;/p&gt;&lt;h3 style=&quot;color:#1a73e8;border-bottom:2px solid #1a73e8;padding-bottom:4px;font-size:15px;&quot;&gt;Opportunity Details&lt;/h3&gt;&lt;table style=&quot;border-collapse:collapse;width:100%;background-color:#ffffff;border-radius:4px;&quot;&gt;&lt;tr&gt;&lt;td style=&quot;padding:6px;font-weight:bold;width:160px;&quot;&gt;Opportunity Name:&lt;/td&gt;&lt;td style=&quot;padding:6px;&quot;&gt;{!$Record.Name}&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;padding:6px;font-weight:bold;&quot;&gt;Account Name:&lt;/td&gt;&lt;td style=&quot;padding:6px;&quot;&gt;{!$Record.Account.Name}&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;padding:6px;font-weight:bold;&quot;&gt;Owner:&lt;/td&gt;&lt;td style=&quot;padding:6px;&quot;&gt;{!$Record.Owner.FirstName} {!$Record.Owner.LastName}&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;padding:6px;font-weight:bold;&quot;&gt;Stage:&lt;/td&gt;&lt;td style=&quot;padding:6px;&quot;&gt;{!$Record.StageName}&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;padding:6px;font-weight:bold;&quot;&gt;Total Gross Margin:&lt;/td&gt;&lt;td style=&quot;padding:6px;&quot;&gt;{!$Record.Amount} {!$Record.CurrencyIsoCode}&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;padding:6px;font-weight:bold;&quot;&gt;Total Revenue:&lt;/td&gt;&lt;td style=&quot;padding:6px;&quot;&gt;{!$Record.Total_Revenue__c} {!$Record.CurrencyIsoCode}&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;h3 style=&quot;color:#1a73e8;border-bottom:2px solid #1a73e8;padding-bottom:4px;font-size:15px;margin-top:20px;&quot;&gt;Industry Segment Details&lt;/h3&gt;&lt;table style=&quot;border-collapse:collapse;width:100%;background-color:#ffffff;border-radius:4px;&quot;&gt;&lt;tr&gt;&lt;td style=&quot;padding:6px;font-weight:bold;width:160px;&quot;&gt;Application:&lt;/td&gt;&lt;td style=&quot;padding:6px;&quot;&gt;{!$Record.Application__r.Name}&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;padding:6px;font-weight:bold;&quot;&gt;Industry Segment:&lt;/td&gt;&lt;td style=&quot;padding:6px;&quot;&gt;{!$Record.Industry_Segment__r.Name}&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;padding:6px;font-weight:bold;&quot;&gt;Global Business Unit:&lt;/td&gt;&lt;td style=&quot;padding:6px;&quot;&gt;{!$Record.Global_Business_Unit__c}&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;h3 style=&quot;color:#1a73e8;border-bottom:2px solid #1a73e8;padding-bottom:4px;font-size:15px;margin-top:20px;&quot;&gt;Opportunity Product Details&lt;/h3&gt;&lt;table style=&quot;border-collapse:collapse;width:100%;margin-bottom:15px;border:1px solid #1a73e8;&quot;&gt;&lt;thead&gt;&lt;tr style=&quot;background-color:#e3f2fd;color:#1a73e8;&quot;&gt;&lt;th style=&quot;border:1px solid #cce0ff;padding:8px;text-align:left;&quot;&gt;Product&lt;/th&gt;&lt;th style=&quot;border:1px solid #cce0ff;padding:8px;text-align:center;&quot;&gt;Quantity&lt;/th&gt;&lt;th style=&quot;border:1px solid #cce0ff;padding:8px;text-align:right;&quot;&gt;Price&lt;/th&gt;&lt;th style=&quot;border:1px solid #cce0ff;padding:8px;text-align:right;&quot;&gt;Gross Margin&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;{!Get_Product_Details.Outputs.OpportunityItemTableRows}&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;&lt;a href=&quot;{!URLBase}/lightning/r/Opportunity/{!$Record.Id}/view&quot; style=&quot;display:inline-block;background-color:#1E90FF;color:#fff;padding:8px 14px;text-decoration:none;border-radius:4px;font-weight:bold;&quot;&gt;View Opportunity in Salesforce&lt;/a&gt;&lt;/p&gt;&lt;br&gt;&lt;p&gt;Best regards,&lt;br&gt;&lt;strong&gt;CRM Support Team&lt;/strong&gt;&lt;/p&gt;&lt;p style=&quot;font-size:12px;color:#666;&quot;&gt;(This is an automated notification from Salesforce.)&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</text>
    </textTemplates>
    <textTemplates>
        <name>emailSubject</name>
        <isViewedAsPlainText>true</isViewedAsPlainText>
        <text>Opportunity Approval Required: {!$Record.Name}</text>
    </textTemplates>
</Flow>
